<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>fritz!box data volume monitor</title>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script src="//cdn.jsdelivr.net/npm/@js-joda/core@1.11.0/dist/js-joda.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/filesize/4.2.1/filesize.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />

    <script>
        $(document).ready(function() {
            // reload every minute
            setInterval('refreshPage()', 60000);
        });

        function refreshPage() {
            location.reload();
        }

        function formatSize(bytes) {
            return filesize(bytes, { locale: "de", round: 3 })
        }

        function appendTimeFrame(fileName, selector) {
            $.getJSON(fileName, function (data) {
                const localIpVolumes = Object.keys(data.local).reduce((acc, localIp) => {
                    acc.push({localIp, ...data.local[localIp]});
                    return acc;
                }, []);
                localIpVolumes.sort((a, b) => b.download - a.download);
                $.each(localIpVolumes, function (idx, entry) {
                    var tblRow = "<tr>" +
                        "<td class='td-ip'>" + entry.localIp + "</td>" +
                        "<td class='td-byte'>" + formatSize(entry.download) + "</td>" +
                        "<td class='td-byte'>" + formatSize(entry.upload) + "</td>" +
                        "</tr>";
                    $(tblRow).appendTo(selector);
                });
            });
        }

        $(function () {
            const HOUR_FORMAT = JSJoda.DateTimeFormatter.ofPattern("uuuu-MM-dd'T'HH");
            const DAY_FORMAT = JSJoda.DateTimeFormatter.ofPattern('uuuu-MM-dd');
            const MONTH_FORMAT = JSJoda.DateTimeFormatter.ofPattern('uuuu-MM');
            const zonedDateTime = JSJoda.ZonedDateTime.now(JSJoda.ZoneId.UTC);

            $("<div>" + zonedDateTime.toString() + "</div>").appendTo("#time");

            const currentHourFileName = zonedDateTime.format(HOUR_FORMAT) + '.json';
            $("<div>" + zonedDateTime.format(HOUR_FORMAT) + "</div>").appendTo("#currentHour .time");
            appendTimeFrame(currentHourFileName, "#currentHour tbody");

            const lastHourFileName = zonedDateTime.minusHours(1).format(HOUR_FORMAT) + '.json';
            $("<div>" + zonedDateTime.minusHours(1).format(HOUR_FORMAT) + "</div>").appendTo("#lastHour .time");
            appendTimeFrame(lastHourFileName, "#lastHour tbody");

            const todayFileName = zonedDateTime.format(DAY_FORMAT) + '.json';
            $("<div>" + zonedDateTime.format(DAY_FORMAT) + "</div>").appendTo("#today .time");
            appendTimeFrame(todayFileName, "#today tbody");

            const yesterdayFileName = zonedDateTime.minusDays(1).format(DAY_FORMAT) + '.json';
            $("<div>" + zonedDateTime.minusDays(1).format(DAY_FORMAT) + "</div>").appendTo("#yesterday .time");
            appendTimeFrame(yesterdayFileName, "#yesterday tbody");

            const currentMonthFileName = zonedDateTime.format(MONTH_FORMAT) + '.json';
            $("<div>" + zonedDateTime.format(MONTH_FORMAT) + "</div>").appendTo("#currentMonth .time");
            appendTimeFrame(currentMonthFileName, "#currentMonth tbody");

            const lastMonthFileName = zonedDateTime.minusMonths(1).format(MONTH_FORMAT) + '.json';
            $("<div>" + zonedDateTime.minusMonths(1).format(MONTH_FORMAT) + "</div>").appendTo("#lastMonth .time");
            appendTimeFrame(lastMonthFileName, "#lastMonth tbody");
        });
    </script>
</head>
<body>
<div class="header">
    <H3>Fritz!Box data volume monitor</H3>
    <H3 id="time"></H3>
</div>
<div class="wrapper">
    <div class="profile" id="currentHour" >
        <H3 class="time">Current hour <span></span></H3>
        <table class="volume-table">
            <thead>
                <th class="th-ip">Local IP</th><th class="th-byte">Download</th><th class="th-byte">Upload</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="profile" id="lastHour">
        <H3 class="time">Last hour <span></span></H3>
        <table class="volume-table">
            <thead>
                <th class="th-ip">Local IP</th><th class="th-byte">Download</th><th class="th-byte">Upload</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="profile" id="today">
        <H3 class="time">Today <span></span></H3>
        <table class="volume-table">
            <thead>
                <th class="th-ip">Local IP</th><th class="th-byte">Download</th><th class="th-byte">Upload</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="profile" id="yesterday">
        <H3 class="time">Yesterday <span></span></H3>
        <table class="volume-table">
            <thead>
                <th class="th-ip">Local IP</th><th class="th-byte">Download</th><th class="th-byte">Upload</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="profile" id="currentMonth">
        <H3 class="time">Current Month <span></span></H3>
        <table class="volume-table">
            <thead>
                <th class="th-ip">Local IP</th><th class="th-byte">Download</th><th class="th-byte">Upload</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="profile" id="lastMonth">
        <H3 class="time">Last Month <span></span></H3>
        <table class="volume-table">
            <thead>
                <th class="th-ip">Local IP</th><th class="th-byte">Download</th><th class="th-byte">Upload</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
</body>
</html>
